package cc.l1k3beef;

import com.sun.net.httpserver.HttpExchange;
import com.sun.net.httpserver.HttpHandler;
import com.sun.net.httpserver.HttpServer;

import java.io.ByteArrayOutputStream;
import java.io.IOException;
import java.io.InputStream;
import java.net.InetSocketAddress;

public class CodeBaseServer {

    public static class HttpFileHandler implements HttpHandler {

        @Override
        public void handle(HttpExchange httpExchange) throws IOException {
            try {
                System.out.println("new http request from " + httpExchange.getRemoteAddress() + " " + httpExchange.getRequestURI());
                String uri = httpExchange.getRequestURI().getPath();
                InputStream inputStream = HttpFileHandler.class.getResourceAsStream(uri);
                ByteArrayOutputStream byteArrayOutputStream = new ByteArrayOutputStream();

                if (inputStream == null) {
                    System.out.println("Not Found");
                } else {
                    while (inputStream.available() > 0) {
                        byteArrayOutputStream.write(inputStream.read());
                    }

                    byte[] bytes = byteArrayOutputStream.toByteArray();
                    httpExchange.sendResponseHeaders(200, (long) bytes.length);
                    httpExchange.getResponseBody().write(bytes);
                }
                httpExchange.close();
            } catch (Exception e) {
                e.printStackTrace();
            }
        }
    }

    public static void start(String ip, int port) {
        try {
            System.out.println("Starting HTTP server, Http Port:" + port);
            HttpServer httpServer = HttpServer.create(new InetSocketAddress(ip, port), 0);
            httpServer.createContext("/", new HttpFileHandler());
            httpServer.setExecutor(null);
            httpServer.start();
        } catch (Exception e) {
            throw new RuntimeException(e.toString());
        }
    }
}
